name: HTML/CSS Snapshot Testing

on:
  workflow_dispatch:   # ðŸ‘ˆ this enables manual runs

jobs:
  snapshot-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install -g playwright
        npm install playwright@latest
        npx playwright install chromium
    

    - name: Create snapshot and diff directories
      run: mkdir -p snapshots/current snapshots/diff

    - name: Generate current snapshot for index.html
      run: |
        npx playwright screenshot \
          --browser=chromium \
          --viewport-size=1440,960 \
          --full-page \
          "file://$PWD/index.html" \
          "snapshots/current/current.png"

    - name: Compare with reference.png using pixelmatch
      run: |
        node --input-type=module -e '
        import fs from "fs";
        import pixelmatch from "pixelmatch";
        import { PNG } from "pngjs";
        const img1 = PNG.sync.read(fs.readFileSync(".github/snapshots/reference.png"));
        const img2 = PNG.sync.read(fs.readFileSync("snapshots/current/current.png"));
        const { width, height } = img1;
        const diff = new PNG({ width, height });
        const mismatches = pixelmatch(img1.data, img2.data, diff.data, width, height, { threshold: 0.1 });
        fs.writeFileSync("snapshots/diff/diff.png", PNG.sync.write(diff));
        const totalPixels = width * height;
        const percentMatch = 1 - mismatches / totalPixels;
        const hasChanges = percentMatch < 0.8; // true if less than 80% match
        fs.writeFileSync("snapshots/has_changes.txt", hasChanges ? "true" : "false");
        console.log(`Pixelmatch: ${mismatches} mismatches, match: ${(percentMatch*100).toFixed(2)}%`);
        '

    - name: Set has_changes output
      id: compare
      run: |
        echo "has_changes=$(cat snapshots/has_changes.txt)" >> $GITHUB_OUTPUT
    
    - name: Generate HTML report
      if: always()
      run: |
        if grep -q true snapshots/has_changes.txt; then
          status_class="status-changed"
          status_text="CHANGED"
        else
          status_class="status-unchanged"
          status_text="UNCHANGED"
        fi
        cat > snapshots/report.html <<EOF
        <!DOCTYPE html>
        <html>
        <head>
          <title>Snapshot Test Report</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .comparison { border: 1px solid #ccc; margin: 20px 0; padding: 20px; }
            .images { display: flex; gap: 20px; flex-wrap: wrap; }
            .image-container { flex: 1; min-width: 300px; }
            .image-container img { max-width: 100%; height: auto; border: 1px solid #ddd; }
            .status-changed { background-color: #fff3cd; }
            .status-unchanged { background-color: #f8f9fa; }
            h1 { color: #333; }
            h2 { color: #666; }
          </style>
        </head>
        <body>
          <h1>HTML/CSS Snapshot Test Report</h1>
          <p>Generated on: $(date)</p>
          <div class="comparison \\${status_class}">
            <h2>index.html - \\${status_text}</h2>
            <div class="images">
              <div class="image-container">
                <h3>Current</h3>
                <img src="current/current.png" alt="Current snapshot">
              </div>
              <div class="image-container">
                <h3>Reference</h3>
                <img src="../../.github/snapshots/reference.png" alt="Reference snapshot">
              </div>
              <div class="image-container">
                <h3>Difference</h3>
                <img src="diff/diff.png" alt="Difference">
              </div>
            </div>
          </div>
        </body></html>
        EOF
    
    - name: Display manual run summary
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "## Manual Snapshot Test Summary"
        echo "- Triggered by: ${{ github.actor }}"
        echo "- Update references: ${{ github.event.inputs.update_references }}"
        echo "- Target files: ${{ github.event.inputs.target_files || 'index.html' }}"
        echo "- Has changes: ${{ steps.compare.outputs.has_changes }}"
    
    - name: Upload snapshots as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: snapshot-test-results
        path: snapshots/
        retention-days: 30

    - name: Fail if visual changes detected
      if: steps.compare.outputs.has_changes == 'true'
      run: |
        echo "Visual changes detected! Please review the diff image in the report."
        exit 1